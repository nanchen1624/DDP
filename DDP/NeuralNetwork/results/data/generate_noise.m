% generating noise files
clear;
clc;
% use strategy generated by dual value to calculate the lower bound
% This is the stock acquisition from Andew Lo and D. Bertsimas (1998)
% We use the linear price impact with information as the example
%%  problem description
% rng(seeds(se));
t1=clock;
T=20; % number of periods
X1=0;
R1=100;
NR=3;
NX=2;
A=[30,7,3;7,25,-5;3,-5,20];
E=20*eye(NR);
B=[50,20;30,20;10,40];
C=[0.8,0.1;0.2,0.6];
sigma_eta=[10,2;2,8];
%% this part gives the closed solution for unconstrained LQ
deltaR=zeros(NR,NR,T);
deltaX=zeros(NR,NX,T);
aRR=zeros(NR,NR,T);% coefficient for R^2
bRX=zeros(NR,NX,T);% coefficient for RX
cXX=zeros(NX,NX,T);% coefficient for X^2
dCON=zeros(T,1); % coefficient for constant term
deltaR(:,:,T)=diag(ones(NR,1));
deltaX(:,:,T)=zeros(NR,NX);
aRR(:,:,T)=(A'+A)/2;
bRX(:,:,T)=B;
cXX(:,:,T)=zeros(NX,NX);
dCON(T)=0;
for t=T-1:-1:1
    deltaR(:,:,t)=aRR(:,:,t+1)^(-1)*(aRR(:,:,t+1)-A/2);
    deltaX(:,:,t)=aRR(:,:,t+1)^(-1)*(bRX(:,:,t+1)*C)/2;
    aRR(:,:,t)=-A'*aRR(:,:,t+1)^(-1)*A/4+(A'+A)/2;
    bRX(:,:,t)=B+bRX(:,:,t+1)*C-(aRR(:,:,t+1)-A/2)'*aRR(:,:,t+1)^(-1)*bRX(:,:,t+1)*C;
    cXX(:,:,t)=C'*cXX(:,:,t+1)*C-(bRX(:,:,t+1)*C)'*aRR(:,:,t+1)^(-1)*(bRX(:,:,t+1)*C)/4;
    dCON(t)=dCON(t+1)+sum(sum(cXX(:,:,t+1).*sigma_eta));
end
%% problem setting
K=10^4; % data size
iteration=4;
% state
X=zeros(iteration+1,NX,T,K);%information
R=zeros(iteration+1,NR,T,K);% remaining stock
R(:,:,1,:)=ones(iteration+1,NR,K)*R1;

% generate state
Eta=zeros(iteration+1,NX,T,K);
for i=1:iteration+1
    for t=1:T-1
        Eta(i,:,t+1,:)=mvnrnd(zeros(1,NX),sigma_eta,K)';
        X(i,:,t+1,:)=C*squeeze(X(i,:,t,:))+squeeze(Eta(i,:,t+1,:));
        %S_temp=R1/T*2*rand(K,1);
        %R(i,t+1,:)=max(squeeze(R(i,t,:))-S_temp,0);
        R(i,:,t+1,:)=R1*rand(NR,K);
    end
end

init_eta = permute(squeeze(Eta(1,:,:,:)), [3,1,2]);
init_X = permute(squeeze(X(1,:,:,:)), [3,1,2]);
init_R = permute(squeeze(R(1,:,:,:)), [3,1,2]);
mean(init_R(:));
mean(init_X(:));
fname = sprintf('noise/input_%d.mat', K);
save(fname, 'init_eta', 'init_X', 'init_R');
